name: Staging Integration Tests

on:
  # Manual trigger - use this when you want to run integration tests
  workflow_dispatch:
    inputs:
      test_path:
        description: 'Test path to run (e.g., tests/integration/ or tests/integration/test_mfa.py)'
        required: false
        default: 'tests/integration/'
        type: string

  # Weekly scheduled run (Sunday 2am UTC) for regression testing
  schedule:
    - cron: '0 2 * * 0'

env:
  AWS_REGION: eu-west-2
  CODEBUILD_PROJECT: a13e-staging-integration-tests

jobs:
  integration-tests:
    name: Run Integration Tests via CodeBuild
    runs-on: ubuntu-latest
    environment: staging

    # Don't run on forks
    if: github.repository == 'osuide/detection-coverage-validator'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start CodeBuild
        id: codebuild
        run: |
          echo "Starting CodeBuild project: $CODEBUILD_PROJECT"

          # Determine test path
          TEST_PATH="${{ inputs.test_path || 'tests/integration/' }}"
          echo "Test path: $TEST_PATH"

          # Start the build with environment variable override
          BUILD_ID=$(aws codebuild start-build \
            --project-name "$CODEBUILD_PROJECT" \
            --source-version "refs/heads/main" \
            --environment-variables-override "name=TEST_PATH,value=$TEST_PATH,type=PLAINTEXT" \
            --query 'build.id' \
            --output text)

          echo "Build started: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

          # Get build URL
          BUILD_URL="https://${AWS_REGION}.console.aws.amazon.com/codesuite/codebuild/projects/${CODEBUILD_PROJECT}/build/${BUILD_ID}"
          echo "Build URL: $BUILD_URL"
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: Wait for CodeBuild completion
        id: wait
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build_id }}"
          echo "Waiting for build: $BUILD_ID"

          MAX_WAIT=900  # 15 minutes max
          WAITED=0
          POLL_INTERVAL=30

          while [ $WAITED -lt $MAX_WAIT ]; do
            STATUS=$(aws codebuild batch-get-builds \
              --ids "$BUILD_ID" \
              --query 'builds[0].buildStatus' \
              --output text)

            echo "Build status: $STATUS (waited ${WAITED}s)"

            case $STATUS in
              SUCCEEDED)
                echo "Build succeeded!"
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
                ;;
              FAILED|FAULT|STOPPED|TIMED_OUT)
                echo "Build failed with status: $STATUS"
                echo "status=failure" >> $GITHUB_OUTPUT
                exit 1
                ;;
              IN_PROGRESS)
                sleep $POLL_INTERVAL
                WAITED=$((WAITED + POLL_INTERVAL))
                ;;
              *)
                echo "Unknown status: $STATUS"
                sleep $POLL_INTERVAL
                WAITED=$((WAITED + POLL_INTERVAL))
                ;;
            esac
          done

          echo "Build timed out after ${MAX_WAIT}s"
          echo "status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: Get build logs
        if: always()
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build_id }}"

          echo "## Build Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build ID: \`$BUILD_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View full logs in AWS Console](${{ steps.codebuild.outputs.build_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get last 100 lines of build output
          LOG_GROUP="/aws/codebuild/$CODEBUILD_PROJECT"
          LOG_STREAM=$(aws codebuild batch-get-builds \
            --ids "$BUILD_ID" \
            --query 'builds[0].logs.streamName' \
            --output text 2>/dev/null || echo "")

          if [ -n "$LOG_STREAM" ] && [ "$LOG_STREAM" != "None" ]; then
            echo "### Test Output (last 100 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            aws logs get-log-events \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$LOG_STREAM" \
              --limit 100 \
              --query 'events[*].message' \
              --output text 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Unable to fetch logs" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  notify-on-failure:
    name: Notify on Failure
    needs: integration-tests
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send failure notification
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "::warning::Staging integration tests failed!"
          echo "Check the workflow run for details: $RUN_URL"
