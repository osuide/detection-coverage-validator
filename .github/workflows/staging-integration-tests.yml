name: Staging Integration Tests

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      test_path:
        description: 'Test path to run (e.g., tests/integration/ or tests/integration/test_mfa.py)'
        required: false
        default: 'tests/integration/'
        type: string

  # Weekly scheduled run (Sunday 2am UTC) for regression testing
  schedule:
    - cron: '0 2 * * 0'

# NOTE: This workflow uses GitHub Actions service containers instead of AWS CodeBuild.
# When a NAT Gateway is added to the VPC, we can switch back to CodeBuild for
# tests that need access to actual staging RDS/Redis.
# See: infrastructure/terraform/modules/codebuild/ for the CodeBuild setup.

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest

    # Don't run on forks
    if: github.repository == 'osuide/detection-coverage-validator'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: dcv_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/dcv_test
      REDIS_URL: redis://localhost:6379/0
      SECRET_KEY: test-secret-key-for-integration-tests-at-least-32-chars
      ENVIRONMENT: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx pyotp

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          until pg_isready -h localhost -p 5432; do sleep 1; done
          echo "PostgreSQL is ready"

          echo "Waiting for Redis..."
          # Use netcat to check Redis port since redis-cli isn't installed on runner
          until nc -z localhost 6379; do sleep 1; done
          echo "Redis is ready"

      - name: Run database migrations
        working-directory: backend
        run: |
          alembic upgrade head

      - name: Run integration tests
        working-directory: backend
        env:
          TEST_PATH: ${{ inputs.test_path || 'tests/integration/' }}
        run: |
          echo "Running tests: $TEST_PATH"
          PYTHONPATH=. pytest "$TEST_PATH" -v --tb=short --junitxml=test-results.xml 2>&1 | tee test-output.txt
        continue-on-error: true
        id: tests

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: |
            backend/test-results.xml
            backend/test-output.txt

      - name: Test Report Summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f backend/test-results.xml ]; then
            # Extract test counts from JUnit XML
            TESTS=$(grep -oP 'tests="\K[0-9]+' backend/test-results.xml | head -1 || echo "0")
            FAILURES=$(grep -oP 'failures="\K[0-9]+' backend/test-results.xml | head -1 || echo "0")
            ERRORS=$(grep -oP 'errors="\K[0-9]+' backend/test-results.xml | head -1 || echo "0")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Tests | $TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failures | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Output (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 backend/test-output.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No output available"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check test result
        if: steps.tests.outcome == 'failure'
        run: exit 1

  notify-on-failure:
    name: Notify on Failure
    needs: integration-tests
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Send failure notification
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "::warning::Integration tests failed!"
          echo "Check the workflow run for details: $RUN_URL"
