"""
T1190 - Exploit Public-Facing Application

Adversaries exploit vulnerabilities in internet-facing applications to gain
initial access. Includes web apps, APIs, and cloud services.
Used by APT28, APT29, APT41, HAFNIUM.
"""

from .template_loader import (
    RemediationTemplate,
    ThreatContext,
    DetectionStrategy,
    DetectionImplementation,
    Campaign,
    DetectionType,
    EffortLevel,
    FalsePositiveRate,
    CloudProvider,
)

TEMPLATE = RemediationTemplate(
    technique_id="T1190",
    technique_name="Exploit Public-Facing Application",
    tactic_ids=["TA0001"],
    mitre_url="https://attack.mitre.org/techniques/T1190/",

    threat_context=ThreatContext(
        description=(
            "Adversaries exploit vulnerabilities in internet-facing applications "
            "including web apps, APIs, databases, and cloud services. Can lead to "
            "access to underlying instances or metadata services."
        ),
        attacker_goal="Gain initial access by exploiting public-facing application vulnerabilities",
        why_technique=[
            "Direct path to internal network",
            "Many known CVEs available",
            "Automated exploitation tools exist",
            "Cloud apps expose metadata services",
            "Often unpatched systems"
        ],
        known_threat_actors=["APT28", "APT29", "APT41", "HAFNIUM", "Magic Hound"],
        recent_campaigns=[
            Campaign(
                name="APT29 VPN Exploitation",
                year=2024,
                description="Exploited Citrix, Pulse Secure, FortiGate, and Zimbra vulnerabilities",
                reference_url="https://attack.mitre.org/groups/G0016/"
            ),
            Campaign(
                name="HAFNIUM Exchange Attacks",
                year=2021,
                description="Exploited multiple Exchange Server vulnerabilities (ProxyLogon)",
                reference_url="https://attack.mitre.org/groups/G0125/"
            )
        ],
        prevalence="common",
        trend="stable",
        severity_score=9,
        severity_reasoning=(
            "Direct initial access technique. Successful exploitation can lead to "
            "full system compromise and access to cloud metadata/credentials."
        ),
        business_impact=[
            "Initial network compromise",
            "Data breach risk",
            "Lateral movement enabler",
            "Cloud credential theft"
        ],
        typical_attack_phase="initial_access",
        often_precedes=["T1078.004", "T1552.005", "T1530"],
        often_follows=[]
    ),

    detection_strategies=[
        DetectionStrategy(
            strategy_id="t1190-aws-waf",
            name="AWS WAF Attack Detection",
            description="Detect exploitation attempts via AWS WAF logs.",
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query='''fields @timestamp, httpRequest.clientIp, httpRequest.uri, action
| filter action = "BLOCK"
| filter terminatingRuleId like /SQL|XSS|RFI|LFI|CVE/
| stats count(*) as blocked by httpRequest.clientIp, bin(1h)
| filter blocked > 10
| sort blocked desc''',
                cloudformation_template='''AWSTemplateFormatVersion: '2010-09-09'
Description: Detect web application attacks via WAF

Parameters:
  WAFLogGroup:
    Type: String
  AlertEmail:
    Type: String

Resources:
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  WAFBlockFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref WAFLogGroup
      FilterPattern: '{ $.action = "BLOCK" }'
      MetricTransformations:
        - MetricName: WAFBlocks
          MetricNamespace: Security
          MetricValue: "1"

  WAFBlockAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: HighWAFBlocks
      MetricName: WAFBlocks
      Namespace: Security
      Statistic: Sum
      Period: 300
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      AlarmActions: [!Ref AlertTopic]''',
                terraform_template='''# Detect web application attacks via WAF

variable "waf_log_group" { type = string }
variable "alert_email" { type = string }

resource "aws_sns_topic" "alerts" {
  name = "waf-attack-alerts"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

resource "aws_cloudwatch_log_metric_filter" "waf_blocks" {
  name           = "waf-blocks"
  log_group_name = var.waf_log_group
  pattern        = "{ $.action = \"BLOCK\" }"

  metric_transformation {
    name      = "WAFBlocks"
    namespace = "Security"
    value     = "1"
  }
}

resource "aws_cloudwatch_metric_alarm" "waf_attacks" {
  alarm_name          = "HighWAFBlocks"
  metric_name         = "WAFBlocks"
  namespace           = "Security"
  statistic           = "Sum"
  period              = 300
  threshold           = 100
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  alarm_actions       = [aws_sns_topic.alerts.arn]
}''',
                alert_severity="high",
                alert_title="Web Application Attack Detected",
                alert_description_template="High volume of WAF blocks from {clientIp}.",
                investigation_steps=[
                    "Review blocked request patterns",
                    "Check for successful bypasses",
                    "Review application logs",
                    "Check for vulnerability matches"
                ],
                containment_actions=[
                    "Block attacking IP at WAF/security group",
                    "Review and patch vulnerabilities",
                    "Enable additional WAF rules",
                    "Check for successful compromise"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="WAF blocks are generally reliable indicators",
            detection_coverage="70% - catches blocked attacks",
            evasion_considerations="Successful exploits bypass WAF",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$10-30",
            prerequisites=["AWS WAF with logging enabled"]
        ),

        DetectionStrategy(
            strategy_id="t1190-aws-alb",
            name="ALB Suspicious Request Detection",
            description="Detect exploitation attempts via ALB access logs.",
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query='''fields @timestamp, client_ip, request_url, elb_status_code
| filter request_url like /\\.\\.|etc|cmd=|exec|script|UNION.*SELECT/
| stats count(*) as suspicious by client_ip, bin(1h)
| filter suspicious > 5
| sort suspicious desc''',
                terraform_template='''# Detect exploitation via ALB logs

variable "alb_log_group" { type = string }
variable "alert_email" { type = string }

resource "aws_sns_topic" "alerts" {
  name = "alb-exploit-alerts"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

resource "aws_cloudwatch_log_metric_filter" "suspicious_requests" {
  name           = "suspicious-requests"
  log_group_name = var.alb_log_group
  pattern        = "[\"..\", \"/etc/\", \"cmd=\", \"<script\"]"

  metric_transformation {
    name      = "SuspiciousRequests"
    namespace = "Security"
    value     = "1"
  }
}

resource "aws_cloudwatch_metric_alarm" "exploit_attempt" {
  alarm_name          = "ExploitAttempt"
  metric_name         = "SuspiciousRequests"
  namespace           = "Security"
  statistic           = "Sum"
  period              = 300
  threshold           = 20
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  alarm_actions       = [aws_sns_topic.alerts.arn]
}''',
                alert_severity="high",
                alert_title="Exploitation Attempt Detected",
                alert_description_template="Suspicious requests from {client_ip}.",
                investigation_steps=[
                    "Review request patterns",
                    "Check application response codes",
                    "Review application logs",
                    "Check for successful exploitation"
                ],
                containment_actions=[
                    "Block attacking IP",
                    "Review application security",
                    "Enable WAF if not present",
                    "Patch vulnerabilities"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Tune patterns for your application",
            detection_coverage="60% - pattern-based detection",
            evasion_considerations="Encoded payloads may evade",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$5-15",
            prerequisites=["ALB access logging enabled"]
        ),

        DetectionStrategy(
            strategy_id="t1190-gcp-armor",
            name="GCP Cloud Armor Attack Detection",
            description="Detect exploitation attempts via Cloud Armor.",
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="cloud_logging",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''resource.type="http_load_balancer"
jsonPayload.enforcedSecurityPolicy.outcome="DENY"''',
                gcp_terraform_template='''# GCP: Detect web attacks via Cloud Armor

variable "project_id" { type = string }
variable "alert_email" { type = string }

resource "google_monitoring_notification_channel" "email" {
  display_name = "Security Alerts"
  type         = "email"
  labels       = { email_address = var.alert_email }
}

resource "google_logging_metric" "armor_blocks" {
  name   = "cloud-armor-blocks"
  filter = <<-EOT
    resource.type="http_load_balancer"
    jsonPayload.enforcedSecurityPolicy.outcome="DENY"
  EOT
  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
  }
}

resource "google_monitoring_alert_policy" "armor_attacks" {
  display_name = "Cloud Armor Attacks"
  combiner     = "OR"
  conditions {
    display_name = "High block rate"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.armor_blocks.name}\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 100
    }
  }
  notification_channels = [google_monitoring_notification_channel.email.id]
}''',
                alert_severity="high",
                alert_title="GCP: Web Application Attack",
                alert_description_template="Cloud Armor blocking exploitation attempts.",
                investigation_steps=[
                    "Review blocked requests",
                    "Check for bypasses",
                    "Review application logs",
                    "Check vulnerabilities"
                ],
                containment_actions=[
                    "Add blocking rules",
                    "Review security policies",
                    "Patch applications"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="Cloud Armor blocks are reliable",
            detection_coverage="70% - catches blocked attacks",
            evasion_considerations="Successful exploits bypass",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$15-30",
            prerequisites=["Cloud Armor enabled"]
        )
    ],

    recommended_order=["t1190-aws-waf", "t1190-gcp-armor", "t1190-aws-alb"],
    total_effort_hours=5.0,
    coverage_improvement="+20% improvement for Initial Access tactic"
)
