"""
T1203 - Exploitation for Client Execution

Adversaries exploit software vulnerabilities in client applications to execute arbitrary code.
Targets browsers, Office applications, and common enterprise software like Adobe Reader and Flash.
Used by APT28, APT29, APT32, APT37, APT41, Lazarus Group, Sandworm Team, MuddyWater, OilRig.
"""

from .template_loader import (
    RemediationTemplate,
    ThreatContext,
    DetectionStrategy,
    DetectionImplementation,
    DetectionType,
    EffortLevel,
    FalsePositiveRate,
    CloudProvider,
)

TEMPLATE = RemediationTemplate(
    technique_id="T1203",
    technique_name="Exploitation for Client Execution",
    tactic_ids=["TA0002"],
    mitre_url="https://attack.mitre.org/techniques/T1203/",
    threat_context=ThreatContext(
        description=(
            "Adversaries exploit software vulnerabilities in client applications to achieve "
            "arbitrary code execution. The technique targets three primary vectors: browser-based "
            "exploits through drive-by compromises and phishing links, Office application exploits "
            "via malicious documents delivered through phishing, and third-party application "
            "vulnerabilities in software like Adobe Reader and Flash. Unlike server-side exploits, "
            "this technique compromises user endpoints directly, often bypassing perimeter defences."
        ),
        attacker_goal="Execute arbitrary code on endpoints by exploiting client application vulnerabilities",
        why_technique=[
            "Direct endpoint compromise bypassing network defences",
            "Numerous known CVEs in widely-deployed client software",
            "Users frequently run vulnerable, unpatched applications",
            "Weaponised documents easily delivered via phishing",
            "Successful exploitation grants attacker code execution context",
            "Exploits available for common enterprise applications",
            "Browser exploits enable drive-by compromise attacks",
        ],
        known_threat_actors=[],
        recent_campaigns=[],  # Populated dynamically from MITRE sync data
        prevalence="common",
        trend="stable",
        severity_score=9,
        severity_reasoning=(
            "Critical initial execution technique enabling direct endpoint compromise. Successful "
            "exploitation provides adversaries with code execution in user context, enabling "
            "credential theft, lateral movement, and data exfiltration. Widespread availability "
            "of exploit code and difficulty patching all client software makes this a persistent threat."
        ),
        business_impact=[
            "Initial code execution on user endpoints",
            "Credential theft from compromised workstations",
            "Malware installation and persistence establishment",
            "Lateral movement from infected endpoints",
            "Data exfiltration from user systems",
            "Ransomware deployment across endpoints",
        ],
        typical_attack_phase="execution",
        often_precedes=["T1059", "T1105", "T1003", "T1078.004", "T1552"],
        often_follows=["T1566", "T1189", "T1204"],
    ),
    detection_strategies=[
        DetectionStrategy(
            strategy_id="t1203-aws-guardduty-exploit",
            name="AWS GuardDuty Exploit Activity Detection",
            description=(
                "Monitor GuardDuty findings for indicators of client-side exploitation including "
                "unusual process behaviour, malware signatures, and command-and-control communication "
                "following successful exploitation."
            ),
            detection_type=DetectionType.GUARDDUTY,
            aws_service="guardduty",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                guardduty_finding_types=[
                    "Execution:EC2/MaliciousFile",
                    "Trojan:EC2/BlackholeTraffic",
                    "Backdoor:EC2/C&CActivity.B!DNS",
                    "UnauthorizedAccess:EC2/MaliciousIPCaller.Custom",
                    "Impact:EC2/WinRMBruteForce",
                    "Execution:Runtime/NewBinaryExecuted",
                ],
                cloudformation_template="""AWSTemplateFormatVersion: '2010-09-09'
Description: GuardDuty monitoring for client exploitation indicators (T1203)

Parameters:
  AlertEmail:
    Type: String
    Description: Email address for security alerts

Resources:
  # Step 1: Create SNS topic for GuardDuty alerts
  GuardDutyAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: alias/aws/sns
      TopicName: t1203-guardduty-exploitation-alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: EventBridge rule to capture exploitation findings
  GuardDutyEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: t1203-guardduty-client-exploitation
      Description: Detect client exploitation activity
      State: ENABLED
      EventPattern:
        source:
          - aws.guardduty
        detail-type:
          - GuardDuty Finding
        detail:
          type:
            - prefix: "Execution:EC2/"
            - prefix: "Trojan:EC2/"
            - prefix: "Backdoor:EC2/"
            - prefix: "UnauthorizedAccess:EC2/"
      Targets:
        - Arn: !Ref GuardDutyAlertTopic
          Id: GuardDutySNSTarget

  # Step 3: Allow EventBridge to publish to SNS
  SNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref GuardDutyAlertTopic
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref GuardDutyAlertTopic
            Condition:
              StringEquals:
                AWS:SourceAccount: !Ref AWS::AccountId
              ArnEquals:
                aws:SourceArn: !GetAtt GuardDutyEventRule.Arn""",
                terraform_template="""# AWS: GuardDuty monitoring for client exploitation (T1203)

variable "alert_email" {
  type        = string
  description = "Email address for security alerts"
}

# Step 1: Create SNS topic for GuardDuty alerts
resource "aws_sns_topic" "guardduty_alerts" {
  name = "t1203-guardduty-exploitation-alerts"
  kms_master_key_id = "alias/aws/sns"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.guardduty_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: EventBridge rule to capture exploitation findings
resource "aws_cloudwatch_event_rule" "guardduty_exploitation" {
  name        = "t1203-guardduty-client-exploitation"
  description = "Detect client exploitation activity"
  state       = "ENABLED"
  event_pattern = jsonencode({
    source      = ["aws.guardduty"]
    detail-type = ["GuardDuty Finding"]
    detail = {
      type = [
        { prefix = "Execution:Runtime/" },
        { prefix = "Trojan:EC2/" },
        { prefix = "Backdoor:EC2/" },
        { prefix = "UnauthorizedAccess:EC2/" }
      ]
    }
  })
}

# DLQ for failed EventBridge deliveries
resource "aws_sqs_queue" "dlq" {
  name                      = "t1203-guardduty-dlq"
  message_retention_seconds = 1209600
}

resource "aws_sqs_queue_policy" "dlq_policy" {
  queue_url = aws_sqs_queue.dlq.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "events.amazonaws.com" }
      Action    = "sqs:SendMessage"
      Resource  = aws_sqs_queue.dlq.arn
      Condition = {
        ArnEquals = {
          "aws:SourceArn" = aws_cloudwatch_event_rule.guardduty_exploitation.arn
        }
      }
    }]
  })
}

# Step 3: Route GuardDuty findings to SNS
resource "aws_cloudwatch_event_target" "sns" {
  rule      = aws_cloudwatch_event_rule.guardduty_exploitation.name
  target_id = "GuardDutySNSTarget"
  arn       = aws_sns_topic.guardduty_alerts.arn

  retry_policy {
    maximum_event_age_in_seconds = 3600
    maximum_retry_attempts       = 8
  }

  dead_letter_config {
    arn = aws_sqs_queue.dlq.arn
  }
  input_transformer {
    input_paths = {
      account    = "$.account"
      region     = "$.region"
      time       = "$.time"
      type       = "$.detail.type"
      severity   = "$.detail.severity"
      title      = "$.detail.title"
      description = "$.detail.description"
    }

    input_template = <<-EOT
"GuardDuty Finding Alert
Time: <time>
Account: <account>
Region: <region>
Finding: <type>
Severity: <severity>
Title: <title>
Description: <description>
Action: Review finding in GuardDuty console and investigate"
EOT
  }

}

data "aws_caller_identity" "current" {}

resource "aws_sns_topic_policy" "allow_eventbridge" {
  arn = aws_sns_topic.guardduty_alerts.arn
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "events.amazonaws.com" }
      Action    = "sns:Publish"
      Resource  = aws_sns_topic.guardduty_alerts.arn
      Condition = {
        StringEquals = {
          "AWS:SourceAccount" = data.aws_caller_identity.current.account_id
        }
        ArnEquals = {
          "aws:SourceArn" = aws_cloudwatch_event_rule.guardduty_exploitation.arn
        }
      }
    }]
  })
}""",
                alert_severity="critical",
                alert_title="Client Exploitation: Malicious Activity Detected",
                alert_description_template=(
                    "Instance {resource.instanceDetails.instanceId} showing exploitation indicators. "
                    "Finding type: {type}. Severity: {severity}. "
                    "Potential client-side exploitation detected."
                ),
                investigation_steps=[
                    "Identify the affected EC2 instance and workload type",
                    "Review recent CloudTrail API activity from the instance",
                    "Check for recently opened documents or downloaded files",
                    "Examine running processes for suspicious applications",
                    "Review VPC Flow Logs for C2 communication patterns",
                    "Analyse browser history and downloaded executables",
                    "Check for registry modifications or persistence mechanisms",
                    "Review IAM credentials and session tokens accessed",
                ],
                containment_actions=[
                    "Isolate the affected instance in quarantine security group",
                    "Terminate suspicious processes and child processes",
                    "Block identified malicious domains/IPs at firewall",
                    "Create forensic snapshot before remediation",
                    "Rotate all IAM credentials accessed from instance",
                    "Scan with updated antivirus and EDR tools",
                    "Re-image the instance from known-good AMI",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="GuardDuty findings are high-confidence; investigate all alerts",
            detection_coverage="75% - detects post-exploitation behaviour and C2 activity",
            evasion_considerations="In-memory fileless exploits may evade initial detection",
            implementation_effort=EffortLevel.LOW,
            implementation_time="30 minutes",
            estimated_monthly_cost="$15-50 depending on instance count",
            prerequisites=["GuardDuty enabled in region"],
        ),
        DetectionStrategy(
            strategy_id="t1203-aws-cloudwatch-crash",
            name="AWS CloudWatch Application Crash Detection",
            description=(
                "Monitor for client application crashes followed by suspicious activity, "
                "implementing MITRE analytics AN0797/AN0798/AN0799 for exploitation detection. "
                "Detects crash events with subsequent file creation and process spawning."
            ),
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query="""fields @timestamp, application, eventType, process.name, process.parent, file.path
| filter eventType = "crash" or eventType = "abnormal_exit"
| filter application like /chrome|firefox|msedge|safari|WINWORD|EXCEL|POWERPNT|AcroRd32/
| stats count(*) as crashes,
        count_distinct(file.path) as files_created,
        count_distinct(process.name) as processes_spawned
  by application, bin(10m)
| filter (crashes > 0 and files_created > 0) or processes_spawned > 2
| sort @timestamp desc""",
                cloudformation_template="""AWSTemplateFormatVersion: '2010-09-09'
Description: Detect client exploitation via crash analysis (T1203)

Parameters:
  LogGroupName:
    Type: String
    Description: CloudWatch log group for endpoint logs
  AlertEmail:
    Type: String

Resources:
  # Step 1: Create SNS topic for alerts
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: alias/aws/sns
      TopicName: t1203-crash-exploitation-alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: Metric filter for application crashes
  AppCrashFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref LogGroupName
      FilterPattern: '[eventType=crash || eventType=abnormal_exit, app=*chrome* || app=*WINWORD* || app=*EXCEL* || app=*firefox* || app=*AcroRd32*]'
      MetricTransformations:
        - MetricName: ClientAppCrash
          MetricNamespace: Security/T1203
          MetricValue: "1"

  # Step 3: Alarm on suspicious crash patterns
  CrashExploitAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: T1203-ClientExploitation
      AlarmDescription: Client application crashes indicating exploitation
      MetricName: ClientAppCrash
      Namespace: Security/T1203
      Statistic: Sum
      Period: 600
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      TreatMissingData: notBreaching

      AlarmActions:
        - !Ref AlertTopic

  TopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics: [!Ref AlertTopic]
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudwatch.amazonaws.com
            Action: sns:Publish
            Resource: !Ref AlertTopic""",
                terraform_template="""# AWS: Detect client exploitation via crash analysis (T1203)

variable "log_group_name" {
  type        = string
  description = "CloudWatch log group for endpoint logs"
}

variable "alert_email" {
  type = string
}

# Step 1: Create SNS topic for alerts
resource "aws_sns_topic" "crash_alerts" {
  name = "t1203-crash-exploitation-alerts"
  kms_master_key_id = "alias/aws/sns"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.crash_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Metric filter for application crashes
resource "aws_cloudwatch_log_metric_filter" "app_crash" {
  name           = "client-application-crashes"
  log_group_name = var.log_group_name
  pattern        = "[eventType=crash || eventType=abnormal_exit, app=*chrome* || app=*WINWORD* || app=*EXCEL* || app=*firefox* || app=*AcroRd32*]"

  metric_transformation {
    name      = "ClientAppCrash"
    namespace = "Security/T1203"
    value     = "1"
  }
}

# Step 3: Alarm on suspicious crash patterns
resource "aws_cloudwatch_metric_alarm" "crash_exploitation" {
  alarm_name          = "T1203-ClientExploitation"
  alarm_description   = "Client application crashes indicating exploitation"
  metric_name         = "ClientAppCrash"
  namespace           = "Security/T1203"
  statistic           = "Sum"
  period              = 600
  threshold           = 3
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  treat_missing_data  = "notBreaching"

  alarm_actions       = [aws_sns_topic.crash_alerts.arn]
}

resource "aws_sns_topic_policy" "allow_cloudwatch" {
  arn = aws_sns_topic.crash_alerts.arn
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "cloudwatch.amazonaws.com" }
      Action    = "sns:Publish"
      Resource  = aws_sns_topic.crash_alerts.arn
    Condition = {
        StringEquals = {
          "AWS:SourceAccount" = data.aws_caller_identity.current.account_id
        }
      }
    }]
  })
}""",
                alert_severity="high",
                alert_title="Client Exploitation: Application Crash with Suspicious Activity",
                alert_description_template=(
                    "Application {application} crashed with subsequent file creation or process spawning. "
                    "{crashes} crashes, {files_created} files created, {processes_spawned} processes spawned."
                ),
                investigation_steps=[
                    "Review crash dumps and exception logs",
                    "Identify documents or URLs opened before crash",
                    "Examine files created in temp/downloads directories",
                    "Check spawned child processes and command lines",
                    "Review memory forensics for exploit artefacts",
                    "Analyse network connections post-crash",
                    "Check Windows Event Logs for application errors",
                    "Review recent downloads and email attachments",
                ],
                containment_actions=[
                    "Isolate affected endpoint from network",
                    "Kill suspicious child processes",
                    "Quarantine malicious documents/files",
                    "Block C2 domains/IPs identified",
                    "Patch vulnerable application immediately",
                    "Scan endpoint with EDR and antivirus",
                    "Re-image endpoint if compromise confirmed",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Baseline normal crash rates; filter legitimate software updates",
            detection_coverage="70% - implements MITRE analytics AN0797/AN0798/AN0799",
            evasion_considerations="Stable exploits that don't crash applications may evade",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$10-25",
            prerequisites=[
                "Endpoint logging to CloudWatch",
                "Application crash logging enabled",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1203-aws-cloudwatch-office",
            name="AWS CloudWatch Office Application Exploitation",
            description=(
                "Detect suspicious Office application behaviour indicating exploitation, including "
                "spawning of PowerShell, CMD, or scripting engines from Word, Excel, or PowerPoint."
            ),
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query="""fields @timestamp, process.name, process.parent, process.commandLine, user
| filter process.parent like /WINWORD|EXCEL|POWERPNT|AcroRd32/
| filter process.name in ["powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe", "regsvr32.exe"]
| stats count(*) as suspicious_spawns,
        count_distinct(process.name) as unique_processes,
        count_distinct(user) as affected_users
  by process.parent, bin(1h)
| filter suspicious_spawns > 0
| sort @timestamp desc""",
                cloudformation_template="""AWSTemplateFormatVersion: '2010-09-09'
Description: Detect Office application exploitation (T1203)

Parameters:
  LogGroupName:
    Type: String
  AlertEmail:
    Type: String

Resources:
  # Step 1: Create SNS topic
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: alias/aws/sns
      TopicName: t1203-office-exploitation-alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: Metric filter for suspicious Office processes
  OfficeExploitFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref LogGroupName
      FilterPattern: '[parent=*WINWORD* || parent=*EXCEL* || parent=*POWERPNT*, process=powershell.exe || process=cmd.exe || process=wscript.exe || process=mshta.exe]'
      MetricTransformations:
        - MetricName: OfficeProcessSpawn
          MetricNamespace: Security/T1203
          MetricValue: "1"

  # Step 3: Alarm on Office exploitation
  OfficeExploitAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: T1203-OfficeExploitation
      AlarmDescription: Office application spawning suspicious processes
      MetricName: OfficeProcessSpawn
      Namespace: Security/T1203
      Statistic: Sum
      Period: 300
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      TreatMissingData: notBreaching

      AlarmActions:
        - !Ref AlertTopic""",
                terraform_template="""# AWS: Detect Office application exploitation (T1203)

variable "log_group_name" {
  type = string
}

variable "alert_email" {
  type = string
}

# Step 1: Create SNS topic
resource "aws_sns_topic" "office_alerts" {
  name = "t1203-office-exploitation-alerts"
  kms_master_key_id = "alias/aws/sns"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.office_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Metric filter for suspicious Office processes
resource "aws_cloudwatch_log_metric_filter" "office_exploit" {
  name           = "office-suspicious-spawns"
  log_group_name = var.log_group_name
  pattern        = "[parent=*WINWORD* || parent=*EXCEL* || parent=*POWERPNT*, process=powershell.exe || process=cmd.exe || process=wscript.exe || process=mshta.exe]"

  metric_transformation {
    name      = "OfficeProcessSpawn"
    namespace = "Security/T1203"
    value     = "1"
  }
}

# Step 3: Alarm on Office exploitation
resource "aws_cloudwatch_metric_alarm" "office_exploitation" {
  alarm_name          = "T1203-OfficeExploitation"
  alarm_description   = "Office application spawning suspicious processes"
  metric_name         = "OfficeProcessSpawn"
  namespace           = "Security/T1203"
  statistic           = "Sum"
  period              = 300
  threshold           = 1
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  treat_missing_data  = "notBreaching"

  alarm_actions       = [aws_sns_topic.office_alerts.arn]
}""",
                alert_severity="critical",
                alert_title="Office Exploitation: Malicious Process Spawned",
                alert_description_template=(
                    "{process.parent} spawned {unique_processes} suspicious processes including {process.name}. "
                    "Command line: {process.commandLine}. Likely exploitation of CVE."
                ),
                investigation_steps=[
                    "Identify the malicious document that was opened",
                    "Extract and analyse document macros and embedded objects",
                    "Review email headers if document arrived via phishing",
                    "Check spawned process command lines for obfuscation",
                    "Analyse PowerShell script blocks if enabled",
                    "Search for known CVE exploitation indicators",
                    "Review user's recent downloads and email attachments",
                    "Check for lateral movement from affected endpoint",
                ],
                containment_actions=[
                    "Isolate affected endpoint immediately",
                    "Kill spawned malicious processes",
                    "Quarantine the malicious document",
                    "Block document hash across organisation",
                    "Disable Office macros via Group Policy if not required",
                    "Apply Office security updates and patches",
                    "Reset user credentials from affected endpoint",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="Whitelist legitimate macro-enabled workflows; very few false positives expected",
            detection_coverage="85% - highly effective for Office exploitation",
            evasion_considerations="Exploits using in-process execution without spawning may evade",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1 hour",
            estimated_monthly_cost="$8-20",
            prerequisites=[
                "Endpoint logging to CloudWatch",
                "Process creation logging enabled",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1203-gcp-chronicle-exploit",
            name="GCP Chronicle Endpoint Exploitation Detection",
            description=(
                "Leverage Chronicle Security to detect client exploitation patterns including "
                "process injection, unusual parent-child relationships, and post-exploitation activity."
            ),
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="chronicle",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''resource.type="chronicle_detection"
(jsonPayload.detection.ruleName=~".*Client.*Exploit.*|.*Office.*Macro.*|.*Browser.*Exploit.*"
OR jsonPayload.detection.category="INITIAL_ACCESS"
   jsonPayload.detection.tags=~".*T1203.*|.*exploitation.*")
severity>="HIGH"''',
                gcp_terraform_template="""# GCP: Chronicle detection for client exploitation (T1203)

variable "project_id" {
  type        = string
  description = "GCP project ID"
}

variable "alert_email" {
  type = string
}

# Step 1: Create notification channel
resource "google_monitoring_notification_channel" "email" {
  project      = var.project_id
  display_name = "T1203 Exploitation Alerts"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 2: Create log metric for exploitation detections
resource "google_logging_metric" "client_exploitation" {
  project = var.project_id
  name   = "t1203-client-exploitation-detections"
  filter = <<-EOT
    resource.type="chronicle_detection"
    (jsonPayload.detection.ruleName=~".*Client.*Exploit.*|.*Office.*Macro.*|.*Browser.*Exploit.*"
    OR (jsonPayload.detection.category="INITIAL_ACCESS" AND jsonPayload.detection.tags=~".*T1203.*|.*exploitation.*"))
    severity>="HIGH"
  EOT
  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    labels {
      key         = "detection_name"
      value_type  = "STRING"
      description = "Detection rule name"
    }
  }
  label_extractors = {
    "detection_name" = "EXTRACT(jsonPayload.detection.ruleName)"
  }
}

# Step 3: Create alert policy
resource "google_monitoring_alert_policy" "exploitation_detection" {
  project      = var.project_id
  display_name = "T1203: Client Exploitation Detected"
  combiner     = "OR"
  conditions {
    display_name = "Client exploitation activity detected"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.client_exploitation.name}\""
      duration        = "60s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0
      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_RATE"
      }
    }
  }
  notification_channels = [google_monitoring_notification_channel.email.id]
  alert_strategy {
    auto_close = "86400s"
    notification_rate_limit {
      period = "300s"
    }
  }
}""",
                alert_severity="critical",
                alert_title="GCP: Client Exploitation Detected",
                alert_description_template=(
                    "Chronicle detected client exploitation: {detection_name}. "
                    "Endpoint affected. Immediate investigation required."
                ),
                investigation_steps=[
                    "Review Chronicle detection details and timeline",
                    "Identify affected VM instance and user account",
                    "Examine process execution chain and parent relationships",
                    "Review Cloud Logging for user activity on instance",
                    "Check VPC Flow Logs for C2 communication",
                    "Analyse any downloaded files or documents",
                    "Review IAM activity from compromised endpoint",
                ],
                containment_actions=[
                    "Isolate affected VM instance in separate VPC",
                    "Terminate malicious processes via OS-Login",
                    "Block identified C2 domains via Cloud DNS policies",
                    "Create forensic snapshot of affected instance",
                    "Rotate service account credentials",
                    "Re-create instance from known-good image",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="Chronicle detections are high-fidelity; investigate all alerts",
            detection_coverage="80% - comprehensive endpoint telemetry analysis",
            evasion_considerations="Requires Chronicle deployment; coverage depends on deployed detection rules",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="45 minutes - 1 hour",
            estimated_monthly_cost="$30-75 (Chronicle licensing dependent)",
            prerequisites=[
                "Chronicle Security enabled",
                "Endpoint telemetry forwarding configured",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1203-gcp-security-command",
            name="GCP Security Command Centre Vulnerability Detection",
            description=(
                "Monitor Security Command Centre for vulnerable software versions and exploitation "
                "attempts targeting client applications on GCP VM instances."
            ),
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="security_command_center",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''resource.type="security_finding"
(jsonPayload.category="SOFTWARE_VULNERABILITY"
OR jsonPayload.category="EXPLOIT_DETECTION")
(jsonPayload.findingClass="THREAT"
OR jsonPayload.severity="CRITICAL")
jsonPayload.resourceName=~".*chrome.*|.*firefox.*|.*acrobat.*|.*office.*"''',
                gcp_terraform_template="""# GCP: Security Command Centre vulnerability monitoring (T1203)

variable "project_id" {
  type        = string
  description = "GCP project ID"
}

variable "alert_email" {
  type = string
}

# Step 1: Create notification channel
resource "google_monitoring_notification_channel" "email" {
  project      = var.project_id
  display_name = "SCC Vulnerability Alerts"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 2: Create log metric for vulnerability findings
resource "google_logging_metric" "vulnerable_clients" {
  project = var.project_id
  name   = "t1203-vulnerable-client-software"
  filter = <<-EOT
    resource.type="security_finding"
    (jsonPayload.category="SOFTWARE_VULNERABILITY" OR jsonPayload.category="EXPLOIT_DETECTION")
    (jsonPayload.findingClass="THREAT" OR jsonPayload.severity="CRITICAL")
    jsonPayload.resourceName=~".*chrome.*|.*firefox.*|.*acrobat.*|.*office.*"
  EOT
  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    labels {
      key         = "vulnerability_cve"
      value_type  = "STRING"
      description = "CVE identifier"
    }
  }
  label_extractors = {
    "vulnerability_cve" = "EXTRACT(jsonPayload.vulnerability.cve.id)"
  }
}

# Step 3: Alert on vulnerable software
resource "google_monitoring_alert_policy" "vulnerable_software" {
  project      = var.project_id
  display_name = "T1203: Vulnerable Client Software Detected"
  combiner     = "OR"
  conditions {
    display_name = "Critical vulnerabilities in client applications"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.vulnerable_clients.name}\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0
      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_RATE"
      }
    }
  }
  notification_channels = [google_monitoring_notification_channel.email.id]

  alert_strategy {
    auto_close = "1800s"
    notification_rate_limit {
      period = "300s"
    }
  }
}""",
                alert_severity="high",
                alert_title="GCP: Vulnerable Client Software Detected",
                alert_description_template=(
                    "Security Command Centre identified vulnerable client software: {vulnerability_cve}. "
                    "Resource: {resourceName}. Exploitation risk."
                ),
                investigation_steps=[
                    "Identify affected VM instances with vulnerable software",
                    "Review CVE details and available exploit code",
                    "Check if instances have internet access",
                    "Review recent Cloud Logging for exploitation attempts",
                    "Determine if patches are available",
                    "Assess business criticality of affected instances",
                ],
                containment_actions=[
                    "Apply security patches immediately",
                    "Restrict internet access if patching delayed",
                    "Deploy virtual patching via firewall rules",
                    "Update VM instance images with patched software",
                    "Implement application isolation if available",
                    "Monitor instances for exploitation attempts",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="SCC findings are accurate; prioritise by CVE severity",
            detection_coverage="60% - identifies vulnerable software, not active exploitation",
            evasion_considerations="Detects vulnerabilities, not exploitation itself; proactive defence",
            implementation_effort=EffortLevel.LOW,
            implementation_time="30 minutes",
            estimated_monthly_cost="$10-20",
            prerequisites=["Security Command Centre Standard or Premium tier"],
        ),
    ],
    recommended_order=[
        "t1203-aws-guardduty-exploit",
        "t1203-aws-cloudwatch-office",
        "t1203-gcp-chronicle-exploit",
        "t1203-aws-cloudwatch-crash",
        "t1203-gcp-security-command",
    ],
    total_effort_hours=5.5,
    coverage_improvement="+22% improvement for Execution tactic",
)
