"""
T1212 - Exploitation for Credential Access

Adversaries exploit software vulnerabilities to obtain credentials or bypass
authentication mechanisms. Includes targeting Kerberos, authentication daemons,
and cloud identity providers. Used by Leviathan, UNC3886.
"""

from .template_loader import (
    RemediationTemplate,
    ThreatContext,
    DetectionStrategy,
    DetectionImplementation,
    Campaign,
    DetectionType,
    EffortLevel,
    FalsePositiveRate,
    CloudProvider,
)

TEMPLATE = RemediationTemplate(
    technique_id="T1212",
    technique_name="Exploitation for Credential Access",
    tactic_ids=["TA0006"],
    mitre_url="https://attack.mitre.org/techniques/T1212/",

    threat_context=ThreatContext(
        description=(
            "Adversaries exploit software vulnerabilities in credentialing and authentication "
            "mechanisms to gain access to useful credentials or bypass authentication processes. "
            "This includes exploiting Kerberos implementations (MS14-068), authentication daemons "
            "(PAM, OpenDirectory), and cloud identity providers to forge tokens or bypass authentication. "
            "In cloud environments, vulnerabilities in identity services, VMware vCenter, and network "
            "appliances are commonly exploited to obtain encrypted credentials and authentication tokens."
        ),
        attacker_goal="Exploit authentication vulnerabilities to obtain credentials or bypass authentication",
        why_technique=[
            "Direct access to credentials without triggering access controls",
            "Bypass authentication entirely via vulnerability exploitation",
            "Forge authentication tokens and tickets",
            "Access encrypted credential stores from vulnerable services",
            "Exploit cloud identity provider vulnerabilities for unintended token creation",
            "Leverage replay attacks to impersonate authenticated users"
        ],
        known_threat_actors=["Leviathan", "UNC3886"],
        recent_campaigns=[
            Campaign(
                name="Leviathan Network Appliance Exploitation",
                year=2023,
                description="Exploited vulnerable network appliances to collect and exfiltrate credentials during C0049 campaign",
                reference_url="https://attack.mitre.org/groups/G0065/"
            ),
            Campaign(
                name="UNC3886 VMware vCenter Exploitation",
                year=2022,
                description="Exploited CVE-2022-22948 in VMware vCenter to obtain encrypted credentials from postgresDB",
                reference_url="https://attack.mitre.org/groups/G1048/"
            )
        ],
        prevalence="uncommon",
        trend="stable",
        severity_score=9,
        severity_reasoning=(
            "Exploitation of authentication mechanisms represents a critical security breach. "
            "Successful exploitation can bypass all authentication controls, provide direct access "
            "to credential material, and enable complete identity impersonation. In cloud environments, "
            "this can lead to mass token forgery and unauthorised access across entire tenancies."
        ),
        business_impact=[
            "Complete authentication bypass",
            "Mass credential theft from identity services",
            "Token forgery and impersonation attacks",
            "Access to encrypted credential databases",
            "Lateral movement with forged credentials",
            "Persistent access via compromised identity infrastructure"
        ],
        typical_attack_phase="credential_access",
        often_precedes=["T1078.004", "T1550", "T1021"],
        often_follows=["T1190", "T1133", "T1199"]
    ),

    detection_strategies=[
        DetectionStrategy(
            strategy_id="t1212-aws-authentication-anomalies",
            name="AWS Authentication Service Anomaly Detection",
            description="Detect unusual authentication patterns and token creation activities in AWS Cognito and IAM.",
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query='''fields @timestamp, userIdentity.principalId, eventName, sourceIPAddress, errorCode
| filter eventSource in ["cognito-idp.amazonaws.com", "sts.amazonaws.com", "iam.amazonaws.com"]
| filter eventName in ["AssumeRole", "GetFederationToken", "InitiateAuth", "AdminInitiateAuth", "CreateAccessKey"]
| filter errorCode != "Success" or requestParameters.tokenDuration > 3600
| stats count(*) as auth_attempts, count_distinct(sourceIPAddress) as unique_ips
  by userIdentity.principalId, eventName, bin(5m)
| filter auth_attempts > 20 or unique_ips > 5
| sort auth_attempts desc''',
                cloudformation_template='''AWSTemplateFormatVersion: '2010-09-09'
Description: Detect authentication service exploitation attempts

Parameters:
  CloudTrailLogGroup:
    Type: String
    Description: CloudTrail log group name
  AlertEmail:
    Type: String

Resources:
  # Step 1: Create SNS topic for alerts
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: Authentication Exploitation Alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: Monitor unusual token creation
  UnusualTokenFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref CloudTrailLogGroup
      FilterPattern: '{ ($.eventName = "AssumeRole" || $.eventName = "GetFederationToken") && $.requestParameters.durationSeconds > 3600 }'
      MetricTransformations:
        - MetricName: LongDurationTokens
          MetricNamespace: Security/T1212
          MetricValue: "1"

  # Step 3: Alert on suspicious token patterns
  TokenAnomalyAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: T1212-AuthenticationExploitation
      AlarmDescription: Unusual authentication token patterns detected
      MetricName: LongDurationTokens
      Namespace: Security/T1212
      Statistic: Sum
      Period: 300
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      AlarmActions: [!Ref AlertTopic]''',
                terraform_template='''# Detect authentication service exploitation attempts

variable "cloudtrail_log_group" {
  type        = string
  description = "CloudTrail log group name"
}

variable "alert_email" {
  type        = string
  description = "Email for security alerts"
}

# Step 1: Create SNS topic for alerts
resource "aws_sns_topic" "auth_exploit_alerts" {
  name         = "authentication-exploitation-alerts"
  display_name = "Authentication Exploitation Alerts"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.auth_exploit_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Monitor unusual token creation
resource "aws_cloudwatch_log_metric_filter" "unusual_tokens" {
  name           = "long-duration-tokens"
  log_group_name = var.cloudtrail_log_group
  pattern        = "{ ($.eventName = \"AssumeRole\" || $.eventName = \"GetFederationToken\") && $.requestParameters.durationSeconds > 3600 }"

  metric_transformation {
    name      = "LongDurationTokens"
    namespace = "Security/T1212"
    value     = "1"
  }
}

# Step 3: Alert on suspicious token patterns
resource "aws_cloudwatch_metric_alarm" "token_anomaly" {
  alarm_name          = "T1212-AuthenticationExploitation"
  alarm_description   = "Unusual authentication token patterns detected"
  metric_name         = "LongDurationTokens"
  namespace           = "Security/T1212"
  statistic           = "Sum"
  period              = 300
  threshold           = 5
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  alarm_actions       = [aws_sns_topic.auth_exploit_alerts.arn]
}''',
                alert_severity="critical",
                alert_title="Authentication Service Exploitation Detected",
                alert_description_template="Unusual authentication token patterns from {principal_id}. {auth_attempts} attempts from {unique_ips} IPs.",
                investigation_steps=[
                    "Review CloudTrail logs for the suspicious principal and source IPs",
                    "Check for any recently patched vulnerabilities in identity services",
                    "Examine token duration and scope requests",
                    "Review recent IAM role and policy changes",
                    "Check for unusual API calls following token creation",
                    "Analyse authentication failure patterns before success"
                ],
                containment_actions=[
                    "Revoke all sessions for the affected principal",
                    "Apply SCPs to limit token duration across organisation",
                    "Enable MFA requirements on sensitive roles",
                    "Review and patch identity service components",
                    "Implement IP allowlisting for authentication services",
                    "Enable advanced authentication monitoring in AWS Security Hub"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Baseline legitimate long-duration tokens for automation systems",
            detection_coverage="65% - catches unusual authentication patterns",
            evasion_considerations="Attackers may use normal token durations to blend in",
            implementation_effort=EffortLevel.LOW,
            implementation_time="1 hour",
            estimated_monthly_cost="$5-10",
            prerequisites=["CloudTrail enabled with STS, IAM, and Cognito events"]
        ),

        DetectionStrategy(
            strategy_id="t1212-aws-guardduty-exploit",
            name="AWS GuardDuty Credential Access Finding Detection",
            description="Detect exploitation attempts targeting credential access via GuardDuty.",
            detection_type=DetectionType.GUARDDUTY,
            aws_service="guardduty",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                guardduty_finding_types=[
                    "CredentialAccess:IAMUser/AnomalousBehavior",
                    "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS",
                    "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS",
                    "CredentialAccess:Kubernetes/AnomalousBehavior.SecretsAccessed",
                    "CredentialAccess:Kubernetes/MaliciousIPCaller.Custom"
                ],
                cloudformation_template='''AWSTemplateFormatVersion: '2010-09-09'
Description: GuardDuty credential access exploitation detection

Parameters:
  AlertEmail:
    Type: String

Resources:
  # Step 1: Ensure GuardDuty is enabled
  GuardDutyDetector:
    Type: AWS::GuardDuty::Detector
    Properties:
      Enable: true
      FindingPublishingFrequency: FIFTEEN_MINUTES

  # Step 2: Create SNS topic for credential access alerts
  CredAccessAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: Credential Access Exploitation Alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 3: Route credential access findings to SNS
  CredentialAccessRule:
    Type: AWS::Events::Rule
    Properties:
      Name: T1212-CredentialAccessExploitation
      Description: Alert on credential access exploitation attempts
      EventPattern:
        source: [aws.guardduty]
        detail:
          type:
            - prefix: "CredentialAccess:"
            - "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS"
            - "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS"
      State: ENABLED
      Targets:
        - Id: CredAccessAlert
          Arn: !Ref CredAccessAlertTopic

  TopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics: [!Ref CredAccessAlertTopic]
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sns:Publish
            Resource: !Ref CredAccessAlertTopic''',
                terraform_template='''# GuardDuty credential access exploitation detection

variable "alert_email" {
  type        = string
  description = "Email for security alerts"
}

# Step 1: Ensure GuardDuty is enabled
resource "aws_guardduty_detector" "main" {
  enable                       = true
  finding_publishing_frequency = "FIFTEEN_MINUTES"

  datasources {
    s3_logs {
      enable = true
    }
    kubernetes {
      audit_logs {
        enable = true
      }
    }
  }
}

# Step 2: Create SNS topic for credential access alerts
resource "aws_sns_topic" "credential_access_alerts" {
  name         = "credential-access-exploitation-alerts"
  display_name = "Credential Access Exploitation Alerts"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.credential_access_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 3: Route credential access findings to SNS
resource "aws_cloudwatch_event_rule" "credential_access" {
  name        = "guardduty-credential-access-exploitation"
  description = "Alert on credential access exploitation attempts"
  event_pattern = jsonencode({
    source = ["aws.guardduty"]
    detail = {
      type = [
        { prefix = "CredentialAccess:" },
        "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS",
        "UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS"
      ]
    }
  })
}

resource "aws_cloudwatch_event_target" "sns" {
  rule      = aws_cloudwatch_event_rule.credential_access.name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.credential_access_alerts.arn
}

resource "aws_sns_topic_policy" "allow_eventbridge" {
  arn = aws_sns_topic.credential_access_alerts.arn
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "events.amazonaws.com" }
      Action    = "sns:Publish"
      Resource  = aws_sns_topic.credential_access_alerts.arn
    }]
  })
}''',
                alert_severity="critical",
                alert_title="GuardDuty: Credential Access Exploitation Detected",
                alert_description_template="GuardDuty detected credential access exploitation. Finding: {finding_type}. Resource: {resource_id}.",
                investigation_steps=[
                    "Review the GuardDuty finding details and severity",
                    "Examine the affected resource and its IAM credentials",
                    "Check CloudTrail for API activity using the compromised credentials",
                    "Review network connections from the affected resource",
                    "Investigate source IP reputation and geolocation",
                    "Check for lateral movement or privilege escalation attempts"
                ],
                containment_actions=[
                    "Immediately revoke compromised credentials",
                    "Isolate affected instances via security group changes",
                    "Rotate all potentially exposed secrets",
                    "Enable MFA on affected accounts",
                    "Review and restrict IAM permissions",
                    "Implement SCPs to prevent credential exfiltration"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning="GuardDuty findings are high-fidelity; review severity levels",
            detection_coverage="80% - comprehensive credential access detection",
            evasion_considerations="Sophisticated attackers may use low-and-slow techniques",
            implementation_effort=EffortLevel.LOW,
            implementation_time="45 minutes",
            estimated_monthly_cost="$4.60 per month base + usage-based",
            prerequisites=["GuardDuty enabled in region"]
        ),

        DetectionStrategy(
            strategy_id="t1212-aws-kerberos-anomalies",
            name="Kerberos and Directory Service Anomaly Detection",
            description="Detect exploitation of Microsoft Active Directory and Kerberos in AWS Directory Service or EC2 domain controllers.",
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query='''fields @timestamp, @message, eventID, targetUserName, ipAddress
| filter eventID in [4768, 4769, 4771, 4625, 4776]
| filter @message like /Ticket.*Encryption|KERB_ERR|Pre-authentication failed|Logon failure/
| stats count(*) as anomalies by targetUserName, ipAddress, eventID, bin(5m)
| filter anomalies > 10
| sort anomalies desc''',
                cloudformation_template='''AWSTemplateFormatVersion: '2010-09-09'
Description: Detect Kerberos exploitation attempts

Parameters:
  DirectoryLogGroup:
    Type: String
    Description: CloudWatch log group for Directory Service or DC logs
  AlertEmail:
    Type: String

Resources:
  # Step 1: Create SNS topic
  KerberosAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: Kerberos Exploitation Alerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: Monitor Kerberos authentication failures
  KerberosFailureFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref DirectoryLogGroup
      FilterPattern: '[time, eventid="4771" || eventid="4768", ...]'
      MetricTransformations:
        - MetricName: KerberosAuthFailures
          MetricNamespace: Security/T1212
          MetricValue: "1"

  # Step 3: Alert on exploitation patterns
  KerberosExploitAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: T1212-KerberosExploitation
      AlarmDescription: Kerberos exploitation patterns detected
      MetricName: KerberosAuthFailures
      Namespace: Security/T1212
      Statistic: Sum
      Period: 300
      Threshold: 20
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      AlarmActions: [!Ref KerberosAlertTopic]''',
                terraform_template='''# Detect Kerberos exploitation attempts

variable "directory_log_group" {
  type        = string
  description = "CloudWatch log group for Directory Service or DC logs"
}

variable "alert_email" {
  type = string
}

# Step 1: Create SNS topic
resource "aws_sns_topic" "kerberos_alerts" {
  name         = "kerberos-exploitation-alerts"
  display_name = "Kerberos Exploitation Alerts"
}

resource "aws_sns_topic_subscription" "email" {
  topic_arn = aws_sns_topic.kerberos_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Monitor Kerberos authentication failures
resource "aws_cloudwatch_log_metric_filter" "kerberos_failures" {
  name           = "kerberos-auth-failures"
  log_group_name = var.directory_log_group
  pattern        = "[time, eventid=\"4771\" || eventid=\"4768\", ...]"

  metric_transformation {
    name      = "KerberosAuthFailures"
    namespace = "Security/T1212"
    value     = "1"
  }
}

# Step 3: Alert on exploitation patterns
resource "aws_cloudwatch_metric_alarm" "kerberos_exploit" {
  alarm_name          = "T1212-KerberosExploitation"
  alarm_description   = "Kerberos exploitation patterns detected"
  metric_name         = "KerberosAuthFailures"
  namespace           = "Security/T1212"
  statistic           = "Sum"
  period              = 300
  threshold           = 20
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  alarm_actions       = [aws_sns_topic.kerberos_alerts.arn]
}''',
                alert_severity="high",
                alert_title="Kerberos Exploitation Detected",
                alert_description_template="Kerberos exploitation patterns detected. User: {target_user_name}, IP: {ip_address}, {anomalies} failures.",
                investigation_steps=[
                    "Review Event IDs 4768, 4769, 4771 for Kerberos anomalies",
                    "Check for ticket encryption downgrade attempts",
                    "Identify source IP and verify if it's internal or external",
                    "Review recent domain controller patches and vulnerabilities",
                    "Check for unusual Kerberos ticket requests (long durations, unusual SPNs)",
                    "Investigate targeted user accounts for compromise"
                ],
                containment_actions=[
                    "Reset passwords for targeted accounts",
                    "Block source IP at network perimeter",
                    "Enable Kerberos armoring if not already enabled",
                    "Patch domain controllers against known Kerberos vulnerabilities",
                    "Review and revoke suspicious Kerberos tickets",
                    "Enable Protected Users security group for sensitive accounts"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Baseline normal authentication failure rates; exclude service accounts",
            detection_coverage="70% - detects Kerberos exploitation patterns",
            evasion_considerations="Attackers may forge valid tickets to avoid failures",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$10-20",
            prerequisites=["AWS Directory Service or EC2 domain controllers with CloudWatch logging"]
        ),

        DetectionStrategy(
            strategy_id="t1212-gcp-identity-exploitation",
            name="GCP Identity and IAM Service Exploitation Detection",
            description="Detect exploitation of GCP Cloud Identity, IAM, and authentication services.",
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="cloud_logging",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''protoPayload.serviceName=~"iam.googleapis.com|iamcredentials.googleapis.com|cloudidentity.googleapis.com"
(protoPayload.methodName=~"GenerateAccessToken|GenerateIdToken|SignJwt|CreateServiceAccountKey"
OR severity>=ERROR)
protoPayload.status.code!=0 OR protoPayload.requestMetadata.callerSuppliedUserAgent=~"exploit|scanner|nuclei"''',
                gcp_terraform_template='''# GCP: Detect identity service exploitation

variable "project_id" {
  type        = string
  description = "GCP project ID"
}

variable "alert_email" {
  type = string
}

# Step 1: Create notification channel
resource "google_monitoring_notification_channel" "email" {
  project      = var.project_id
  display_name = "Identity Exploitation Alerts"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 2: Create log-based metric for identity exploitation
resource "google_logging_metric" "identity_exploitation" {
  project = var.project_id
  name    = "identity-service-exploitation"
  filter  = <<-EOT
    protoPayload.serviceName=~"iam.googleapis.com|iamcredentials.googleapis.com|cloudidentity.googleapis.com"
    (protoPayload.methodName=~"GenerateAccessToken|GenerateIdToken|SignJwt|CreateServiceAccountKey"
    OR severity>=ERROR)
    protoPayload.status.code!=0
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    labels {
      key         = "caller_ip"
      value_type  = "STRING"
      description = "Source IP of exploitation attempt"
    }
    labels {
      key         = "method_name"
      value_type  = "STRING"
      description = "Exploited method"
    }
  }

  label_extractors = {
    caller_ip   = "EXTRACT(protoPayload.requestMetadata.callerIp)"
    method_name = "EXTRACT(protoPayload.methodName)"
  }
}

# Step 3: Create alert policy
resource "google_monitoring_alert_policy" "identity_exploitation" {
  project      = var.project_id
  display_name = "T1212: Identity Service Exploitation"
  combiner     = "OR"
  conditions {
    display_name = "Identity exploitation attempts"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.identity_exploitation.name}\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 10
      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_RATE"
      }
    }
  }
  notification_channels = [google_monitoring_notification_channel.email.id]
  alert_strategy {
    auto_close = "1800s"
  }
  documentation {
    content   = "Identity service exploitation detected. Multiple failed authentication operations from same source. Investigate immediately."
    mime_type = "text/markdown"
  }
}''',
                alert_severity="critical",
                alert_title="GCP: Identity Service Exploitation Detected",
                alert_description_template="Identity exploitation detected. Method: {method_name}, Source IP: {caller_ip}. Investigate immediately.",
                investigation_steps=[
                    "Review Cloud Audit Logs for the suspicious service account or user",
                    "Check for recently disclosed vulnerabilities in IAM services",
                    "Examine the authentication method and token claims",
                    "Review service account key creation and usage patterns",
                    "Investigate source IP geolocation and reputation",
                    "Check for unusual API calls following token generation"
                ],
                containment_actions=[
                    "Disable compromised service accounts immediately",
                    "Delete suspicious service account keys",
                    "Enable VPC Service Controls to limit IAM API access",
                    "Implement organisation policy constraints on token lifetime",
                    "Review and restrict IAM permissions",
                    "Enable Access Transparency for sensitive operations"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Exclude legitimate automation workflows; baseline normal failure rates",
            detection_coverage="70% - detects IAM exploitation attempts",
            evasion_considerations="Attackers may use valid credentials to avoid errors",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1.5 hours",
            estimated_monthly_cost="$10-25",
            prerequisites=["Cloud Audit Logs enabled for IAM services"]
        ),

        DetectionStrategy(
            strategy_id="t1212-gcp-workload-identity",
            name="GCP Workload Identity Exploitation Detection",
            description="Detect exploitation of GKE Workload Identity and service account impersonation.",
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="cloud_logging",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''resource.type="k8s_cluster"
protoPayload.methodName="io.k8s.core.v1.serviceaccounts.token.create"
OR (protoPayload.serviceName="iamcredentials.googleapis.com"
    protoPayload.methodName="GenerateAccessToken"
    protoPayload.authenticationInfo.principalEmail=~"gserviceaccount.com")''',
                gcp_terraform_template='''# GCP: Detect Workload Identity exploitation

variable "project_id" {
  type = string
}

variable "alert_email" {
  type = string
}

resource "google_monitoring_notification_channel" "email" {
  project      = var.project_id
  display_name = "Workload Identity Alerts"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 1: Monitor service account token creation in GKE
resource "google_logging_metric" "workload_identity_tokens" {
  project = var.project_id
  name    = "workload-identity-token-creation"
  filter  = <<-EOT
    resource.type="k8s_cluster"
    protoPayload.methodName="io.k8s.core.v1.serviceaccounts.token.create"
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    labels {
      key         = "service_account"
      value_type  = "STRING"
      description = "Kubernetes service account"
    }
  }

  label_extractors = {
    service_account = "EXTRACT(protoPayload.request.metadata.name)"
  }
}

# Step 2: Monitor GCP service account impersonation
resource "google_logging_metric" "sa_impersonation" {
  project = var.project_id
  name    = "service-account-impersonation"
  filter  = <<-EOT
    protoPayload.serviceName="iamcredentials.googleapis.com"
    protoPayload.methodName="GenerateAccessToken"
    protoPayload.authenticationInfo.principalEmail=~"gserviceaccount.com"
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
  }
}

# Step 3: Alert on unusual token generation
resource "google_monitoring_alert_policy" "workload_identity_exploit" {
  project      = var.project_id
  display_name = "T1212: Workload Identity Exploitation"
  combiner     = "OR"
  conditions {
    display_name = "Excessive token generation"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.workload_identity_tokens.name}\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 50
      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_SUM"
      }
    }
  }
  notification_channels = [google_monitoring_notification_channel.email.id]
  documentation {
    content   = "Unusual Workload Identity token generation detected. May indicate exploitation of service account authentication."
    mime_type = "text/markdown"
  }
}''',
                alert_severity="high",
                alert_title="GCP: Workload Identity Exploitation Detected",
                alert_description_template="Unusual Workload Identity activity. Service Account: {service_account}. Investigate token generation patterns.",
                investigation_steps=[
                    "Review the Kubernetes service account and associated GCP service account",
                    "Check GKE pod manifests for unusual service account bindings",
                    "Examine token audience and scope claims",
                    "Review recent changes to Workload Identity IAM bindings",
                    "Investigate pods using the compromised service account",
                    "Check for privilege escalation via service account impersonation chains"
                ],
                containment_actions=[
                    "Delete suspicious pods using the service account",
                    "Remove IAM bindings for Workload Identity if compromised",
                    "Rotate service account keys",
                    "Implement Workload Identity constraints via organisation policies",
                    "Enable Binary Authorisation to prevent unauthorised images",
                    "Review and restrict service account permissions"
                ]
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning="Baseline normal token generation for workloads; exclude batch jobs",
            detection_coverage="75% - detects Workload Identity abuse",
            evasion_considerations="Attackers may generate tokens within normal thresholds",
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="2 hours",
            estimated_monthly_cost="$15-30",
            prerequisites=["GKE with Workload Identity enabled", "Cloud Audit Logs for GKE and IAM"]
        )
    ],

    recommended_order=[
        "t1212-aws-guardduty-exploit",
        "t1212-aws-authentication-anomalies",
        "t1212-gcp-identity-exploitation",
        "t1212-aws-kerberos-anomalies",
        "t1212-gcp-workload-identity"
    ],
    total_effort_hours=7.5,
    coverage_improvement="+25% improvement for Credential Access tactic"
)
