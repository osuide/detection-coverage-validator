"""
T1210 - Exploitation of Remote Services

Adversaries exploit software vulnerabilities in remote services to gain unauthorised
access within networks for lateral movement. Commonly targets SMB, RDP, MySQL, and
virtualisation services like VMware vCenter.
Used by APT28, Emotet, WannaCry, TrickBot, FIN7, Dragonfly.
"""

from .template_loader import (
    RemediationTemplate,
    ThreatContext,
    DetectionStrategy,
    DetectionImplementation,
    DetectionType,
    EffortLevel,
    FalsePositiveRate,
    CloudProvider,
)

TEMPLATE = RemediationTemplate(
    technique_id="T1210",
    technique_name="Exploitation of Remote Services",
    tactic_ids=["TA0008"],  # Lateral Movement
    mitre_url="https://attack.mitre.org/techniques/T1210/",
    threat_context=ThreatContext(
        description=(
            "Adversaries exploit software vulnerabilities in remote services to gain "
            "unauthorised access within networks post-compromise. This technique facilitates "
            "lateral movement by targeting accessible remote systems including SMB, RDP, "
            "MySQL, web servers, and VMware vCenter. Notable exploits include EternalBlue "
            "(MS17-010), BlueKeep (CVE-2019-0708), and ZeroLogon (CVE-2020-1472)."
        ),
        attacker_goal="Exploit remote service vulnerabilities to move laterally through the network",
        why_technique=[
            "Worm-like propagation across networks",
            "Well-known exploits widely available",
            "Many unpatched systems in enterprises",
            "Direct code execution on target systems",
            "Enables rapid lateral movement",
            "Often bypasses authentication",
        ],
        known_threat_actors=[],
        recent_campaigns=[],  # Populated dynamically from MITRE sync data
        prevalence="common",
        trend="stable",
        severity_score=9,
        severity_reasoning=(
            "Enables rapid lateral movement and network-wide compromise. Automated "
            "exploitation can lead to worm-like propagation. Often results in domain "
            "controller compromise and full Active Directory takeover."
        ),
        business_impact=[
            "Rapid network-wide compromise",
            "Domain controller takeover",
            "Critical system exploitation",
            "Ransomware deployment at scale",
            "Data exfiltration from multiple systems",
            "Business continuity disruption",
        ],
        typical_attack_phase="lateral_movement",
        often_precedes=[
            "T1003",
            "T1098",
            "T1486",
            "T1485",
        ],  # Credential dumping, account manipulation, encryption, destruction
        often_follows=[
            "T1078.004",
            "T1190",
            "T1133",
        ],  # Cloud accounts, public exploits, external remote services
    ),
    detection_strategies=[
        DetectionStrategy(
            strategy_id="t1210-aws-vpc",
            name="VPC Flow Logs Lateral Movement Detection",
            description="Detect lateral movement via exploitation of remote services through VPC flow logs.",
            detection_type=DetectionType.CLOUDWATCH_QUERY,
            aws_service="cloudwatch",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                query="""fields @timestamp, srcAddr, dstAddr, dstPort, action, protocol
| filter action = "ACCEPT"
| filter dstPort in [445, 135, 139, 3389, 5985, 5986, 3306, 5900, 22]
| stats count(*) as connections by srcAddr, dstAddr, dstPort, bin(5m)
| filter connections > 10
| sort connections desc""",
                cloudformation_template="""AWSTemplateFormatVersion: '2010-09-09'
Description: Detect lateral movement via remote service exploitation

Parameters:
  VPCFlowLogGroup:
    Type: String
    Description: CloudWatch log group for VPC flow logs
  AlertEmail:
    Type: String
    Description: Email for security alerts

Resources:
  # Step 1: Create SNS topic for alerts
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: alias/aws/sns
      TopicName: RemoteServiceExploitAlerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  # Step 2: Create metric filter for suspicious connections
  LateralMovementFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref VPCFlowLogGroup
      FilterPattern: '[version, account, eni, source, destination, srcport, destport="445" || destport="3389" || destport="135" || destport="139" || destport="5985" || destport="5986", protocol, packets, bytes, windowstart, windowend, action="ACCEPT", flowlogstatus]'
      MetricTransformations:
        - MetricName: SuspiciousRemoteConnections
          MetricNamespace: Security/LateralMovement
          MetricValue: "1"
          DefaultValue: 0

  # Step 3: Create alarm for high connection volume
  LateralMovementAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: HighRemoteServiceConnections
      AlarmDescription: Potential lateral movement via remote service exploitation
      MetricName: SuspiciousRemoteConnections
      Namespace: Security/LateralMovement
      Statistic: Sum
      Period: 300
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      TreatMissingData: notBreaching

      AlarmActions:
        - !Ref AlertTopic""",
                terraform_template="""# AWS: Detect lateral movement via remote service exploitation

variable "vpc_flow_log_group" {
  description = "CloudWatch log group for VPC flow logs"
  type        = string
}

variable "alert_email" {
  description = "Email for security alerts"
  type        = string
}

# Step 1: Create SNS topic for alerts
resource "aws_sns_topic" "remote_exploit_alerts" {
  name = "remote-service-exploit-alerts"
  kms_master_key_id = "alias/aws/sns"
}

resource "aws_sns_topic_subscription" "email_alerts" {
  topic_arn = aws_sns_topic.remote_exploit_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Create metric filter for suspicious connections
resource "aws_cloudwatch_log_metric_filter" "lateral_movement" {
  name           = "suspicious-remote-connections"
  log_group_name = var.vpc_flow_log_group
  pattern        = "[version, account, eni, source, destination, srcport, destport=\"445\" || destport=\"3389\" || destport=\"135\" || destport=\"139\" || destport=\"5985\" || destport=\"5986\", protocol, packets, bytes, windowstart, windowend, action=\"ACCEPT\", flowlogstatus]"

  metric_transformation {
    name      = "SuspiciousRemoteConnections"
    namespace = "Security/LateralMovement"
    value     = "1"
    default_value = 0
  }
}

# Step 3: Create alarm for high connection volume
resource "aws_cloudwatch_metric_alarm" "lateral_movement_alarm" {
  alarm_name          = "HighRemoteServiceConnections"
  alarm_description   = "Potential lateral movement via remote service exploitation"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "SuspiciousRemoteConnections"
  namespace           = "Security/LateralMovement"
  period              = 300
  statistic           = "Sum"
  threshold           = 50
  treat_missing_data  = "notBreaching"

  alarm_actions       = [aws_sns_topic.remote_exploit_alerts.arn]
}""",
                alert_severity="critical",
                alert_title="Remote Service Exploitation Detected",
                alert_description_template=(
                    "High volume of connections to exploitation-prone remote services detected from "
                    "{srcAddr} to {dstAddr}:{dstPort}. This may indicate lateral movement via "
                    "service exploitation (e.g., EternalBlue, BlueKeep, ZeroLogon)."
                ),
                investigation_steps=[
                    "Identify source and destination instances",
                    "Review CloudTrail for related API activity",
                    "Check target instances for signs of compromise (new processes, users, scheduled tasks)",
                    "Review GuardDuty findings for related alerts",
                    "Examine Security Hub for vulnerability scan results",
                    "Check for unusual authentication attempts",
                    "Review recent patch status of affected systems",
                    "Look for process injection or credential dumping activity",
                ],
                containment_actions=[
                    "Isolate compromised instances via security group changes",
                    "Disable compromised user accounts and rotate credentials",
                    "Apply emergency patches for exploited vulnerabilities",
                    "Block lateral movement via network ACLs",
                    "Create forensic snapshots before remediation",
                    "Review and restrict security group rules",
                    "Enable IMDSv2 to prevent metadata service abuse",
                    "Initiate incident response procedures",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning=(
                "Tune thresholds based on normal administrative activity. Whitelist known "
                "management systems (SCCM, Ansible, Systems Manager). Correlate with time-of-day "
                "patterns and approved change windows."
            ),
            detection_coverage="70% - detects network-level exploitation patterns",
            evasion_considerations=(
                "Attackers may use non-standard ports, slow connection rates, or exploit services "
                "on allowed ports. VPC flow logs don't capture packet payloads."
            ),
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="2-3 hours",
            estimated_monthly_cost="$20-50 (depending on VPC flow log volume)",
            prerequisites=[
                "VPC Flow Logs enabled and sent to CloudWatch Logs",
                "Appropriate IAM permissions for CloudWatch and SNS",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1210-aws-guardduty",
            name="GuardDuty Exploit Detection",
            description="Detect exploitation attempts using GuardDuty threat intelligence.",
            detection_type=DetectionType.GUARDDUTY,
            aws_service="guardduty",
            cloud_provider=CloudProvider.AWS,
            implementation=DetectionImplementation(
                guardduty_finding_types=[
                    "Backdoor:EC2/C&CActivity.B!DNS",
                    "Behavior:EC2/NetworkPortUnusual",
                    "Behavior:EC2/TrafficVolumeUnusual",
                    "Impact:EC2/WinRMBruteForce",
                    "Impact:EC2/PortSweep",
                    "Recon:EC2/PortProbeUnprotectedPort",
                    "UnauthorizedAccess:EC2/RDPBruteForce",
                    "UnauthorizedAccess:EC2/SSHBruteForce",
                ],
                terraform_template="""# AWS: GuardDuty exploit detection with EventBridge

variable "alert_email" {
  description = "Email for GuardDuty alerts"
  type        = string
}

# Step 1: Create SNS topic for GuardDuty alerts
resource "aws_sns_topic" "guardduty_alerts" {
  name = "guardduty-exploit-alerts"
  kms_master_key_id = "alias/aws/sns"
}

resource "aws_sns_topic_subscription" "guardduty_email" {
  topic_arn = aws_sns_topic.guardduty_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Step 2: Create EventBridge rule for exploitation findings
resource "aws_cloudwatch_event_rule" "exploitation_findings" {
  name        = "guardduty-exploitation-findings"
  description = "Capture GuardDuty findings related to service exploitation"

  event_pattern = jsonencode({
    source      = ["aws.guardduty"]
    detail-type = ["GuardDuty Finding"]
    detail = {
      type = [
        "Backdoor:EC2/C&CActivity.B!DNS",
        "Behavior:EC2/NetworkPortUnusual",
        "Behavior:EC2/TrafficVolumeUnusual",
        "Impact:EC2/WinRMBruteForce",
        "Impact:EC2/PortSweep",
        "Recon:EC2/PortProbeUnprotectedPort",
        "UnauthorizedAccess:EC2/RDPBruteForce",
        "UnauthorizedAccess:EC2/SSHBruteForce"
      ]
      severity = [{
        numeric = [{ ">=": 7 }]
      }]
    }
  })
}

# DLQ for failed EventBridge deliveries
resource "aws_sqs_queue" "dlq" {
  name                      = "guardduty-exploit-dlq"
  message_retention_seconds = 1209600
}

resource "aws_sqs_queue_policy" "dlq_policy" {
  queue_url = aws_sqs_queue.dlq.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect    = "Allow"
      Principal = { Service = "events.amazonaws.com" }
      Action    = "sqs:SendMessage"
      Resource  = aws_sqs_queue.dlq.arn
      Condition = {
        ArnEquals = {
          "aws:SourceArn" = aws_cloudwatch_event_rule.exploitation_findings.arn
        }
      }
    }]
  })
}

# Step 3: Route findings to SNS for alerting
resource "aws_cloudwatch_event_target" "sns_target" {
  rule      = aws_cloudwatch_event_rule.exploitation_findings.name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.guardduty_alerts.arn

  retry_policy {
    maximum_event_age_in_seconds = 3600
    maximum_retry_attempts       = 8
  }

  dead_letter_config {
    arn = aws_sqs_queue.dlq.arn
  }
  input_transformer {
    input_paths = {
      account    = "$.account"
      region     = "$.region"
      time       = "$.time"
      type       = "$.detail.type"
      severity   = "$.detail.severity"
      title      = "$.detail.title"
      description = "$.detail.description"
    }

    input_template = <<-EOT
"GuardDuty Finding Alert
Time: <time>
Account: <account>
Region: <region>
Finding: <type>
Severity: <severity>
Title: <title>
Description: <description>
Action: Review finding in GuardDuty console and investigate"
EOT
  }

}

data "aws_caller_identity" "current" {}

resource "aws_sns_topic_policy" "guardduty_publish" {
  arn = aws_sns_topic.guardduty_alerts.arn
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        Service = "events.amazonaws.com"
      }
      Action   = "SNS:Publish"
      Resource = aws_sns_topic.guardduty_alerts.arn
      Condition = {
        StringEquals = {
          "AWS:SourceAccount" = data.aws_caller_identity.current.account_id
        }
        ArnEquals = {
          "aws:SourceArn" = aws_cloudwatch_event_rule.exploitation_findings.arn
        }
      }
    }]
  })
}""",
                cloudformation_template="""AWSTemplateFormatVersion: '2010-09-09'
Description: GuardDuty exploitation detection with EventBridge

Parameters:
  AlertEmail:
    Type: String
    Description: Email for GuardDuty alerts

Resources:
  # Step 1: Create SNS topic for alerts
  GuardDutyAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: alias/aws/sns
      TopicName: GuardDutyExploitAlerts
      Subscription:
        - Protocol: email
          Endpoint: !Ref AlertEmail

  GuardDutyTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref GuardDutyAlertTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: 'SNS:Publish'
            Resource: !Ref GuardDutyAlertTopic
            Condition:
              StringEquals:
                AWS:SourceAccount: !Ref AWS::AccountId
              ArnEquals:
                aws:SourceArn: !GetAtt ExploitationFindingsRule.Arn

  # Step 2: Create EventBridge rule for exploitation findings
  ExploitationFindingsRule:
    Type: AWS::Events::Rule
    Properties:
      Name: guardduty-exploitation-findings
      Description: Capture GuardDuty exploitation findings
      EventPattern:
        source:
          - aws.guardduty
        detail-type:
          - GuardDuty Finding
        detail:
          type:
            - 'Backdoor:EC2/C&CActivity.B!DNS'
            - 'Behavior:EC2/NetworkPortUnusual'
            - 'Behavior:EC2/TrafficVolumeUnusual'
            - 'Impact:EC2/WinRMBruteForce'
            - 'Impact:EC2/PortSweep'
            - 'Recon:EC2/PortProbeUnprotectedPort'
            - 'UnauthorizedAccess:EC2/RDPBruteForce'
            - 'UnauthorizedAccess:EC2/SSHBruteForce'
          severity:
            numeric:
              - '>='
              - 7
      State: ENABLED
      Targets:
        - Arn: !Ref GuardDutyAlertTopic
          Id: SNSTarget""",
                alert_severity="high",
                alert_title="GuardDuty: Service Exploitation Activity",
                alert_description_template=(
                    "GuardDuty detected potential service exploitation activity: {findingType}. "
                    "Resource: {resource.instanceDetails.instanceId}"
                ),
                investigation_steps=[
                    "Review GuardDuty finding details and severity",
                    "Identify affected instances and their roles",
                    "Check for related findings in Security Hub",
                    "Review VPC flow logs for connection patterns",
                    "Examine CloudTrail for unusual API activity",
                    "Check instance system logs for exploitation indicators",
                    "Review recent patch compliance status",
                ],
                containment_actions=[
                    "Isolate affected instances",
                    "Block malicious IPs at security group level",
                    "Rotate credentials for affected instances",
                    "Apply security patches immediately",
                    "Enable enhanced monitoring",
                    "Create forensic snapshots",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning=(
                "GuardDuty findings are generally high-fidelity. Suppress findings for known "
                "vulnerability scanners and security tools."
            ),
            detection_coverage="80% - comprehensive threat intelligence coverage",
            evasion_considerations=(
                "May miss zero-day exploits or novel exploitation techniques not in GuardDuty's "
                "threat intelligence database."
            ),
            implementation_effort=EffortLevel.LOW,
            implementation_time="30 minutes",
            estimated_monthly_cost="$5-15 (GuardDuty pricing varies by volume)",
            prerequisites=[
                "GuardDuty enabled in the region",
                "EventBridge permissions configured",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1210-gcp-vpc",
            name="GCP VPC Flow Logs Lateral Movement Detection",
            description="Detect lateral movement via exploitation using GCP VPC flow logs.",
            detection_type=DetectionType.CLOUD_LOGGING_QUERY,
            aws_service="n/a",
            gcp_service="cloud_logging",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                gcp_logging_query='''resource.type="gce_subnetwork"
logName="projects/PROJECT_ID/logs/compute.googleapis.com%2Fvpc_flows"
jsonPayload.connection.dest_port=(445 OR 3389 OR 135 OR 139 OR 5985 OR 5986 OR 3306 OR 5900 OR 22)
jsonPayload.reporter="SRC"''',
                gcp_terraform_template="""# GCP: Detect lateral movement via remote service exploitation

variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "alert_email" {
  description = "Email for security alerts"
  type        = string
}

# Step 1: Create notification channel for alerts
resource "google_monitoring_notification_channel" "security_email" {
  project      = var.project_id
  display_name = "Security Alert Email"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 2: Create log-based metric for suspicious connections
resource "google_logging_metric" "lateral_movement_connections" {
  name    = "lateral-movement-remote-services"
  project = var.project_id
  filter  = <<-EOT
    resource.type="gce_subnetwork"
    logName="projects/${var.project_id}/logs/compute.googleapis.com%2Fvpc_flows"
    jsonPayload.connection.dest_port=(445 OR 3389 OR 135 OR 139 OR 5985 OR 5986 OR 3306 OR 5900 OR 22)
    jsonPayload.reporter="SRC"
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    unit        = "1"
    labels {
      key         = "src_ip"
      value_type  = "STRING"
      description = "Source IP address"
    }
    labels {
      key         = "dest_port"
      value_type  = "STRING"
      description = "Destination port"
    }
  }

  label_extractors = {
    "src_ip"    = "EXTRACT(jsonPayload.connection.src_ip)"
    "dest_port" = "EXTRACT(jsonPayload.connection.dest_port)"
  }
}

# Step 3: Create alerting policy for high connection volume
resource "google_monitoring_alert_policy" "lateral_movement_alert" {
  project      = var.project_id
  display_name = "High Remote Service Connection Volume"
  combiner     = "OR"

  conditions {
    display_name = "Suspicious lateral movement detected"
    condition_threshold {
      filter          = "resource.type=\"gce_subnetwork\" AND metric.type=\"logging.googleapis.com/user/${google_logging_metric.lateral_movement_connections.name}\""
      duration        = "300s"
      comparison      = "COMPARISON_GT"
      threshold_value = 50
      aggregations {
        alignment_period   = "300s"
        per_series_aligner = "ALIGN_SUM"
      }
    }
  }

  notification_channels = [google_monitoring_notification_channel.security_email.id]

  alert_strategy {
    auto_close = "1800s"
    notification_rate_limit {
      period = "300s"
    }
  }

  documentation {
    content   = "Potential lateral movement via remote service exploitation detected. High volume of connections to exploitation-prone services (SMB, RDP, WinRM, SSH, MySQL)."
    mime_type = "text/markdown"
  }
}""",
                alert_severity="critical",
                alert_title="GCP: Remote Service Exploitation Detected",
                alert_description_template=(
                    "High volume of connections to exploitation-prone remote services detected. "
                    "Source: {src_ip}, Port: {dest_port}. Potential lateral movement activity."
                ),
                investigation_steps=[
                    "Review VPC flow logs for connection patterns",
                    "Identify source and destination compute instances",
                    "Check Cloud Audit Logs for related API activity",
                    "Review Security Command Centre findings",
                    "Examine instance serial console logs",
                    "Check for unusual service account activity",
                    "Review recent OS patch compliance status",
                    "Look for credential access attempts in logs",
                ],
                containment_actions=[
                    "Apply firewall rules to isolate affected instances",
                    "Disable compromised service accounts",
                    "Rotate instance credentials and SSH keys",
                    "Apply security patches via OS Patch Management",
                    "Create disk snapshots for forensic analysis",
                    "Review and tighten VPC firewall rules",
                    "Enable VPC Service Controls if not already active",
                    "Initiate incident response procedures",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning=(
                "Whitelist known management systems and administrative source IPs. Adjust thresholds "
                "based on normal operational patterns and maintenance windows."
            ),
            detection_coverage="70% - detects network-level exploitation patterns",
            evasion_considerations=(
                "Attackers may use non-standard ports or slow connection rates. Flow logs don't "
                "capture packet contents or application-layer exploitation details."
            ),
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="2-3 hours",
            estimated_monthly_cost="£15-40 (depending on flow log volume)",
            prerequisites=[
                "VPC Flow Logs enabled on relevant subnets",
                "Cloud Logging API enabled",
                "Monitoring API enabled",
            ],
        ),
        DetectionStrategy(
            strategy_id="t1210-gcp-scc",
            name="GCP Security Command Centre Vulnerability Exploitation",
            description="Detect exploitation of known vulnerabilities via Security Command Centre.",
            detection_type=DetectionType.SECURITY_COMMAND_CENTER,
            aws_service="n/a",
            gcp_service="security_command_center",
            cloud_provider=CloudProvider.GCP,
            implementation=DetectionImplementation(
                scc_finding_categories=[
                    "CRITICAL_VULNERABILITY",
                    "HIGH_VULNERABILITY",
                    "MALWARE",
                    "LATERAL_MOVEMENT",
                ],
                gcp_terraform_template="""# GCP: Security Command Centre exploitation detection

variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "organisation_id" {
  description = "GCP organisation ID"
  type        = string
}

variable "alert_email" {
  description = "Email for security alerts"
  type        = string
}

# Step 1: Create notification channel
resource "google_monitoring_notification_channel" "scc_alerts" {
  project      = var.project_id
  display_name = "SCC Exploitation Alerts"
  type         = "email"
  labels = {
    email_address = var.alert_email
  }
}

# Step 2: Create notification config for critical findings
resource "google_scc_notification_config" "exploitation_findings" {
  config_id    = "exploitation-findings-notify"
  organization = var.organisation_id
  description  = "Alert on exploitation-related Security Command Centre findings"
  pubsub_topic = google_pubsub_topic.scc_notifications.id

  streaming_config {
    filter = <<-EOT
      (category="CRITICAL_VULNERABILITY" OR category="HIGH_VULNERABILITY" OR
       category="MALWARE" OR category="LATERAL_MOVEMENT") AND state="ACTIVE"
    EOT
  }
}

resource "google_pubsub_topic" "scc_notifications" {
  name    = "scc-exploitation-notifications"
  project = var.project_id
}

# Step 3: Create log-based alerting on Pub/Sub messages
resource "google_logging_metric" "scc_exploitation_findings" {
  name    = "scc-exploitation-findings"
  project = var.project_id
  filter  = <<-EOT
    resource.type="pubsub_topic"
    resource.labels.topic_id="scc-exploitation-notifications"
    jsonPayload.finding.category=("CRITICAL_VULNERABILITY" OR "HIGH_VULNERABILITY" OR "MALWARE" OR "LATERAL_MOVEMENT")
  EOT

  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
  }
}

resource "google_monitoring_alert_policy" "scc_exploitation_alert" {
  project      = var.project_id
  display_name = "Security Command Centre: Exploitation Detected"
  combiner     = "OR"

  conditions {
    display_name = "Critical exploitation findings"
    condition_threshold {
      filter          = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.scc_exploitation_findings.name}\""
      duration        = "60s"
      comparison      = "COMPARISON_GT"
      threshold_value = 0
      aggregations {
        alignment_period   = "60s"
        per_series_aligner = "ALIGN_SUM"
      }
    }
  }

  notification_channels = [google_monitoring_notification_channel.scc_alerts.id]

  alert_strategy {
    auto_close = "1800s"
    notification_rate_limit {
      period = "300s"
    }
  }

  documentation {
    content   = "Security Command Centre detected critical vulnerability exploitation or lateral movement activity. Immediate investigation required."
    mime_type = "text/markdown"
  }
}""",
                alert_severity="critical",
                alert_title="GCP SCC: Service Exploitation Activity",
                alert_description_template=(
                    "Security Command Centre detected exploitation activity: {finding.category}. "
                    "Resource: {finding.resourceName}"
                ),
                investigation_steps=[
                    "Review SCC finding details and evidence",
                    "Identify affected resources and their exposure",
                    "Check vulnerability scanner results",
                    "Review Cloud Audit Logs for related activity",
                    "Examine VPC flow logs for lateral movement",
                    "Check for active vulnerabilities using Cloud Asset Inventory",
                    "Review patch compliance via OS Patch Management",
                ],
                containment_actions=[
                    "Isolate affected instances via firewall rules",
                    "Apply emergency patches for exploited vulnerabilities",
                    "Disable compromised service accounts",
                    "Enable enhanced logging and monitoring",
                    "Create forensic disk snapshots",
                    "Review and update vulnerability management process",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.LOW,
            false_positive_tuning=(
                "SCC findings are generally high-fidelity. Suppress findings for known test "
                "environments or approved security research activities."
            ),
            detection_coverage="85% - comprehensive vulnerability and exploitation coverage",
            evasion_considerations=(
                "May miss zero-day exploits or vulnerabilities not yet in vulnerability databases. "
                "Requires active scanning to detect vulnerabilities."
            ),
            implementation_effort=EffortLevel.LOW,
            implementation_time="1 hour",
            estimated_monthly_cost="£30-100 (SCC Standard tier pricing)",
            prerequisites=[
                "Security Command Centre Standard or Premium tier enabled",
                "Vulnerability scanning enabled",
                "Pub/Sub API enabled",
            ],
        ),
        # Azure Strategy: Exploitation of Remote Services
        DetectionStrategy(
            strategy_id="t1210-azure",
            name="Azure Exploitation of Remote Services Detection",
            description=(
                "Azure detection for Exploitation of Remote Services. "
                "Provides native Azure detection using Log Analytics and Defender for Cloud."
            ),
            detection_type=DetectionType.SENTINEL_RULE,
            aws_service="n/a",
            azure_service="sentinel",
            cloud_provider=CloudProvider.AZURE,
            implementation=DetectionImplementation(
                sentinel_rule_query="""// Sentinel Analytics Rule: Exploitation of Remote Services
// MITRE ATT&CK: T1210
let lookback = 24h;
let threshold = 5;
AzureActivity
| where TimeGenerated > ago(lookback)
| where CategoryValue == "Administrative"
| where ActivityStatusValue in ("Success", "Succeeded")
| summarize
    EventCount = count(),
    DistinctOperations = dcount(OperationNameValue),
    Operations = make_set(OperationNameValue, 20),
    Resources = make_set(Resource, 10),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated)
    by Caller, CallerIpAddress, SubscriptionId
| where EventCount > threshold
| extend
    AccountName = tostring(split(Caller, "@")[0]),
    AccountDomain = tostring(split(Caller, "@")[1])
| project
    TimeGenerated = LastSeen,
    AccountName,
    AccountDomain,
    Caller,
    CallerIpAddress,
    SubscriptionId,
    EventCount,
    DistinctOperations,
    Operations,
    Resources""",
                azure_terraform_template="""# Azure Detection for Exploitation of Remote Services
# MITRE ATT&CK: T1210

terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = ">= 3.0"
    }
  }
}

variable "resource_group_name" {
  type        = string
  description = "Resource group for Log Analytics workspace"
}

variable "log_analytics_workspace_id" {
  type        = string
  description = "Log Analytics workspace resource ID"
}

variable "alert_email" {
  type        = string
  description = "Email for security alerts"
}

# Action Group for alerts
resource "azurerm_monitor_action_group" "security_alerts" {
  name                = "exploitation-of-remote-services-alerts"
  resource_group_name = var.resource_group_name
  short_name          = "SecAlerts"

  email_receiver {
    name          = "security-team"
    email_address = var.alert_email
  }
}

# Scheduled Query Rule for detection
resource "azurerm_monitor_scheduled_query_rules_alert_v2" "detection" {
  name                = "exploitation-of-remote-services-detection"
  resource_group_name = var.resource_group_name
  location            = "uksouth"

  evaluation_frequency = "PT5M"
  window_duration      = "PT1H"
  scopes               = [var.log_analytics_workspace_id]
  severity             = 2

  criteria {
    query = <<-QUERY
// Sentinel Analytics Rule: Exploitation of Remote Services
// MITRE ATT&CK: T1210
let lookback = 24h;
let threshold = 5;
AzureActivity
| where TimeGenerated > ago(lookback)
| where CategoryValue == "Administrative"
| where ActivityStatusValue in ("Success", "Succeeded")
| summarize
    EventCount = count(),
    DistinctOperations = dcount(OperationNameValue),
    Operations = make_set(OperationNameValue, 20),
    Resources = make_set(Resource, 10),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated)
    by Caller, CallerIpAddress, SubscriptionId
| where EventCount > threshold
| extend
    AccountName = tostring(split(Caller, "@")[0]),
    AccountDomain = tostring(split(Caller, "@")[1])
| project
    TimeGenerated = LastSeen,
    AccountName,
    AccountDomain,
    Caller,
    CallerIpAddress,
    SubscriptionId,
    EventCount,
    DistinctOperations,
    Operations,
    Resources
    QUERY

    time_aggregation_method = "Count"
    threshold               = 1
    operator                = "GreaterThanOrEqual"

    failing_periods {
      minimum_failing_periods_to_trigger_alert = 1
      number_of_evaluation_periods             = 1
    }
  }

  auto_mitigation_enabled = false

  action {
    action_groups = [azurerm_monitor_action_group.security_alerts.id]
  }

  description = "Detects Exploitation of Remote Services (T1210) activity in Azure environment"
  display_name = "Exploitation of Remote Services Detection"
  enabled      = true

  tags = {
    "mitre-technique" = "T1210"
    "detection-type"  = "security"
  }
}

output "alert_rule_id" {
  value = azurerm_monitor_scheduled_query_rules_alert_v2.detection.id
}""",
                alert_severity="high",
                alert_title="Azure: Exploitation of Remote Services Detected",
                alert_description_template=(
                    "Exploitation of Remote Services activity detected. "
                    "Caller: {Caller}. Resource: {Resource}."
                ),
                investigation_steps=[
                    "Review Azure Activity Log for full operation details",
                    "Check caller identity and verify if authorised",
                    "Review affected resources and assess impact",
                    "Check for related activities in the same time window",
                    "Verify against change management records",
                ],
                containment_actions=[
                    "Disable compromised user/service principal if unauthorised",
                    "Revoke active sessions using Entra ID",
                    "Review and restrict Azure RBAC permissions",
                    "Enable additional Defender for Cloud protections",
                    "Implement Azure Policy to prevent recurrence",
                ],
            ),
            estimated_false_positive_rate=FalsePositiveRate.MEDIUM,
            false_positive_tuning=(
                "Allowlist known automation accounts and CI/CD service principals. "
                "Use Azure Policy to define expected behaviour baselines."
            ),
            detection_coverage="70% - Azure-native detection for cloud operations",
            evasion_considerations=(
                "Attackers may use legitimate credentials from expected locations. "
                "Combine with Defender for Cloud for ML-based anomaly detection."
            ),
            implementation_effort=EffortLevel.MEDIUM,
            implementation_time="1-2 hours",
            estimated_monthly_cost="$10-50 (Log Analytics + Defender)",
            prerequisites=[
                "Azure subscription with Log Analytics workspace",
                "Defender for Cloud enabled (recommended)",
                "Appropriate Azure RBAC permissions for deployment",
            ],
        ),
    ],
    recommended_order=[
        "t1210-aws-guardduty",
        "t1210-gcp-scc",
        "t1210-aws-vpc",
        "t1210-gcp-vpc",
    ],
    total_effort_hours=6.5,
    coverage_improvement="+25% improvement for Lateral Movement tactic",
)
